#!/bin/bash

# 启动 ssh 服务
/etc/init.d/ssh start

# 配置网卡
tunctl -t tap0
ifconfig tap0 192.168.2.1/24

# 启动 http 服务
nohup python3 -m http.server 8000 1>&/dev/null &

# 进入 qemu 镜像目录
cd /root/images
local_ip=`ifconfig eth0 | grep "inet addr:" | awk '{print $2}' | cut -c 6-`
local_port=80
# 获取仿真服务IP地址
if [ -z "$REMOTE_IP" ]; then
    # 如果为空，则设置默认值
    remote_ip='192.168.2.2'
else
    remote_ip=${REMOTE_IP}
fi
if [ -z "$REMOTE_PORT" ]; then
    # 如果为空，则设置默认值
    remote_port=37215
else
    remote_port=${REMOTE_PORT}
fi

tmux new -s "local" -d "for i in {1..10} ;do ssh -L ${local_ip}:${local_port}:${remote_ip}:${remote_port} root@${local_ip} -o ConnectTimeout=10 -o StrictHostKeyChecking=no; echo $i; echo 'restart'; sleep 10s ;done"

echo "Begining emulating"
/usr/bin/expect<<EOF
set timeout 10000
spawn qemu-system-mips -M malta -kernel vmlinux-3.2.0-4-4kc-malta -hda debian_wheezy_mips_standard.qcow2 -append "root=/dev/sda1 console=tty0" -netdev tap,id=tapnet,ifname=tap0,script=no -device rtl8139,netdev=tapnet -nographic
expect "debian-mips login:"
send "root\r"
expect "Password:"
send "root\r"
expect "root@debian-mips:~# "
send "ifconfig eth0 192.168.2.2/24\r"
#expect "root@debian-mips:~# "
#send "echo 0 > /proc/sys/kernel/randomize_va_space\r"
expect "root@debian-mips:~# "
send "scp root@192.168.2.1:/root/squashfs-root.tar.gz /root/squashfs-root.tar.gz\r"
expect {
    "(yes/no)? " { send "yes\r"; exp_continue }
    "password: " { send "root\r" }
}
expect "root@debian-mips:~# "
send "tar xzf squashfs-root.tar.gz && rm squashfs-root.tar.gz\r"
expect "root@debian-mips:~# "
send "mount -o bind /dev ./squashfs-root/dev && mount -t proc /proc ./squashfs-root/proc\r"
expect "root@debian-mips:~# "
send "scp -r root@192.168.2.1:/root/tools /root/squashfs-root/tools\r"
expect {
    "(yes/no)? " { send "yes\r"; exp_continue }
    "password: " { send "root\r" }
}
expect "root@debian-mips:~# "
send "echo 'sleep 30' > net.sh\r"
expect "root@debian-mips:~# "
send "echo 'ifconfig eth0 192.168.2.2/24' >> net.sh\r"
expect "root@debian-mips:~# "
send "echo 'ifconfig br0 192.168.2.3/24' >> net.sh\r"
expect "root@debian-mips:~# "
send "chmod +x net.sh && /bin/sh net.sh &\r"
expect "root@debian-mips:~# "
send "chroot squashfs-root/ sh\r"
expect "# "
send "./bin/upnp\r"
expect "# "
send "./bin/mic\r"
expect eof
EOF

echo "run.sh ending"