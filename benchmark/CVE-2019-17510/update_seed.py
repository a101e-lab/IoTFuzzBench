import time

import requests
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.options import Options

def get_new_token(target_ip,target_port):
    chrome_options = Options()
    chrome_options.add_argument("--headless")
    chrome_options.add_argument("--no-sandbox")
    # driver = webdriver.Chrome(options=chrome_options,executable_path='./chromedriver')
    driver = webdriver.Chrome(options=chrome_options)
    login_url = 'http://'+target_ip+':'+str(target_port)
    driver.get(login_url)
    time.sleep(2)
    try:
        driver.find_element(By.XPATH,'//*[@id="gotoLogin"]').click()
        time.sleep(2)
    except:
        driver.find_element(By.XPATH, '//*[@id="gotoLogin"]').click()
    cookies_str = 'Cookie: '
    cookies = driver.get_cookies()
    count = 0
    for cookie in cookies:
        if (count == 0):
            cookies_str = cookies_str + cookie['name'] + '=' + cookie['value']
        else:
            cookies_str = cookies_str + '; ' + cookie['name'] + '=' + cookie['value']
        count = count+1
    print(cookies_str)
    return cookies_str


def set_new_token(seed,new_token):

    cookie_begin = seed.find('Cookie')
    cookie_end = seed.find('\n',cookie_begin)
    seed_begin = seed[:cookie_begin]
    seed_end = seed[cookie_end:]
    updated_seed = seed_begin + new_token + seed_end
    return updated_seed

def update_seed(seed='',target_ip = '192.168.0.1',target_port = 80):
    print(seed)
    print(target_ip)
    print(target_port)
    new_token = get_new_token(target_ip, target_port)
    updated_seed = set_new_token(seed, new_token)

    return updated_seed

if __name__ == '__main__':
    target_ip = '0.0.0.0'
    target_port = 49500
    seed = '''POST /HNAP1/ HTTP/1.1
Host: 192.168.0.1
User-Agent: Mozilla/5.0 (X11; Linux aarch64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: application/json
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/json
SOAPACTION: "http://purenetworks.com/HNAP1/SetWizardConfig"
HNAP_AUTH: 11583A1E429EF67F912D6EE6D079E244 1666080008220
Content-Length: 77
Origin: http://192.168.0.1
Connection: close
Referer: http://192.168.0.1/Parentcontrol.html?t=1666079999406
Cookie: Authorization=Basic%20YWRtaW46MjEyMzJmMjk3YTU3YTVhNzQzODk0YTBlNGE4MDFmYzM%3D; SESSION_ID=2:1598955110:2; uid=GXUVzvPV; PrivateKey=7EC245C12637DC82AB0D61E5194799F8; timeout=0; PHPSESSID=eb73ebfa5417d36e1bafa4685589c564
Cache-Control: max-age=0

{"SetWizardConfig":{"wl(1).(0)_ssid":"arebwqea","wl(0).(0)_ssid":"arebwqea"}}'''
    updated_seed = update_seed(seed,target_ip,target_port)
    print(updated_seed)
