import requests
import re

import requests


def get_new_token(target_ip,target_port):
    burp0_url = "http://"+target_ip+":"+str(target_port)+"/userRpm/LoginRpm.htm?Save=Save"
    burp0_cookies = {"Authorization": "Basic%20YWRtaW46MjEyMzJmMjk3YTU3YTVhNzQzODk0YTBlNGE4MDFmYzM%3D"}
    burp0_headers = {"User-Agent": "Mozilla/5.0 (X11; Linux aarch64; rv:78.0) Gecko/20100101 Firefox/78.0", "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8", "Accept-Language": "en-US,en;q=0.5", "Accept-Encoding": "gzip, deflate", "Connection": "close", "Referer": "http://192.168.0.1/", "Upgrade-Insecure-Requests": "1"}

    results = requests.get(burp0_url, headers=burp0_headers, cookies=burp0_cookies)
    results_str = results.text

    new_token = results_str[results_str.find('userRpm')-17:results_str.find('userRpm')-1]

    return new_token

def set_new_token(seed,new_token):
    seed_begin = seed[:seed.find('/')+1]
    seed_end = seed[seed.find('userRpm')-1:]
    updated_seed = seed_begin + new_token + seed_end
    return updated_seed

def update_seed(seed='',target_ip = '192.168.0.1',target_port = 80):
    new_token = get_new_token(target_ip,target_port)

    for i in range(5):
        if not new_token.isupper():
            new_token = get_new_token(target_ip,target_port)
        else:
            break

    updated_seed = set_new_token(seed,new_token)

    return updated_seed

if __name__ == '__main__':
    target_ip = '192.168.0.1'
    target_port = 80
    seed = '''GET /DWFSOAYBSYXBAXRA/userRpm/PingIframeRpm.htm?ping_addr=127.0.0.1&doType=ping&isNew=new&sendNum=20&pSize=64&overTime=800&trHops=20 HTTP/1.1
Host: 127.0.0.1:8081
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:76.0) Gecko/20100101 Firefox/76.0
Accept-Encoding: gzip, deflate
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Connection: close
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Referer: http://127.0.0.1:8081/DWFSOAYBSYXBAXRA/userRpm/PingIframeRpm.htm
Cookie: Authorization=Basic%20YWRtaW46MjEyMzJmMjk3YTU3YTVhNzQzODk0YTBlNGE4MDFmYzM%3D
Upgrade-Insecure-Requests: 1

'''
    updated_seed = update_seed(seed,target_ip,target_port)
    print(updated_seed)
