FROM fat_ubuntu1604:v6

WORKDIR /root

# Installing binwalk 
RUN apt update
ADD ./firmware /root/firmware

ADD setup.sh /root/
RUN bash setup.sh

# Uncompressing
# ENTRYPOINT ["binwalk"]
RUN binwalk -Mer --run-as=root /root/firmware/US_AC15V1.0BR_V15.03.05.19_multi_TD01.bin

COPY ./firmware/ /root/firmware/


# Installing qemu

RUN apt-get update \
    && apt-get install -y qemu-system-arm \
    && apt-get install -y --no-install-recommends bridge-utils uml-utilities expect gdb-multiarch git python3-dev openssh-server netcat curl libssl-dev libffi-dev build-essential tcpdump \
    && sed -i "s/PermitRootLogin prohibit-password/PermitRootLogin yes/g" /etc/ssh/sshd_config && echo "root:root" | chpasswd && echo "GatewayPorts yes" >>  /etc/ssh/sshd_config \
    && git clone --depth=1 https://github.com/hugsy/gef.git \
    && cp gef/gef.py ~/.gef.py && echo "source ~/.gef.py" > ~/.gdbinit && echo "export LC_CTYPE=C.UTF-8" >> ~/.bashrc \
    && python3 -m pip install --upgrade pwntools \
    && apt-get purge -y --autoremove git \
    && rm -rf /var/lib/apt/lists/* /root/gef

RUN mkdir images && cd images \
   && wget https://people.debian.org/~aurel32/qemu/armhf/debian_wheezy_armhf_standard.qcow2 \
   && wget https://people.debian.org/~aurel32/qemu/armhf/initrd.img-3.2.0-4-vexpress \
   && wget https://people.debian.org/~aurel32/qemu/armhf/vmlinuz-3.2.0-4-vexpress


# # Simulation
RUN cp -r /root/firmware/_*/squashfs-root /root/squashfs-root/
WORKDIR /root
RUN tar czf squashfs-root.tar.gz ./squashfs-root \
    && rm -rf ./squashfs-root
RUN apt-get update
RUN apt-get install -y tmux net-tools ssh tcpdump
COPY ./tools /root/tools

COPY ./run.sh /root/run.sh
RUN ssh-keygen -b 2048 -f /root/.ssh/id_rsa -t rsa -q -N "" && \
    cp /root/.ssh/id_rsa.pub /root/.ssh/authorized_keys

RUN mkdir /pcap
EXPOSE 80
CMD [ "/bin/sh", "-c", "./run.sh" ]

