import requests
import re

def get_new_token(target_ip,target_port):
    burp0_url = "http://"+target_ip+":"+str(target_port)+"/cgi-bin/get/New_GUI/get_sessionKey.asp"
    burp0_headers = {"User-Agent": "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:107.0) Gecko/20100101 Firefox/107.0", "Accept": "text/plain, */*; q=0.01", "Accept-Language": "en-US,en;q=0.5", "Accept-Encoding": "gzip, deflate", "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8", "X-Requested-With": "XMLHttpRequest", "Origin": "http://"+target_ip, "Connection": "close", "Referer": "http://"+target_ip+"/cgi-bin/New_GUI/Home.asp"}

    results = requests.get(burp0_url, headers=burp0_headers)
    results_str = results.text

    new_token = results_str

    return new_token

def set_new_token(seed,new_token):
    seed_begin = seed[:seed.find('Key')+4]
    seed_end = seed[seed.find('&')-0:]
    updated_seed = seed_begin + new_token + seed_end
    return updated_seed

def update_seed(seed='',target_ip = '192.168.1.1',target_port = 80):
    new_token = get_new_token(target_ip,target_port)
    
    for i in range(5):
        if not new_token.isupper():
            new_token = get_new_token(target_ip,target_port)
        else:
            break
    print(new_token)
    updated_seed = set_new_token(seed,new_token)

    return updated_seed

if __name__ == '__main__':
    target_ip = '192.168.1.1'
    target_port = 80
    seed = '''POST /cgi-bin/New_GUI/Set/Diagnostics.asp HTTP/1.1
Host: 192.168.1.1
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:107.0) Gecko/20100101 Firefox/107.0
Accept: text/plain, */*; q=0.01
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
X-Requested-With: XMLHttpRequest
Content-Length: 153
Origin: http://192.168.1.1
Connection: close
Referer: http://192.168.1.1/cgi-bin/New_GUI/Home.asp

sessionKey=1804289383&Type=p&Addr=aaa
'''
    updated_seed = update_seed(seed,target_ip,target_port)
    print(updated_seed)
